<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Optimum cuts</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<style>
    hr.result{
        border: 1px solid #775c6a;
        margin-right: 70%;
    }
    input.graphics{
        height: 24px;
        width: 60px;
    }
    .barType {
        margin-left: 30%;
    }

    .top-buffer { margin-top: 10px; }
    /*
     BAR VISUALS
    */
    div.d90{
        background-color: #ccc;
        border: 5px solid #ccc;
        height: 24px;
        position: relative;
        width: 100%;
    }

    div.d135l{
        content: '45';
        position: absolute;
        border: 12px solid #ccc;
        top: -5px;
        left: -5px;
        /*border-top: white;*/
        /*border-right: transparent;*/
        /*border-bottom: transparent;*/
        /*border-left: white;*/
        border-color: white transparent transparent white;
    }

    div.d135r{
        content: '45';
        position: absolute;
        right: -5px;
        top: -5px;
        border: 12px solid #ccc;
        /*border-color: #ccc transparent white transparent;*/
        border-right-color: white;
        border-top-color: white;
        border-bottom-color: transparent;
    }

    div.d45l {
        position: absolute;
        /*height: 15px;*/
        border: 12px solid #ccc;
        top: -5px;
        left: -5px;
        border-color: transparent transparent white white;
    }

    div.d45r{
        content: '45';
        position: absolute;
        right: -5px;
        top: -5px;
        border: 12px solid #ccc;
        /*border-color: #ccc transparent white transparent;*/
        border-right-color: white;
        border-top-color: #ccc;
        border-bottom-color: white;
    }
</style>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<body>
<script>
    const CLASS_NAME_NO= 'no_input_';
    const CLASS_NAME_LENGTH= 'length_input_';
    const BAR_LENGTH= 'bar_length';
    const CLASS_NAME_PROFILE_TYPE_LEFT = 'profile_type_left';
    const CLASS_NAME_PROFILE_TYPE_RIGHT = 'profile_type_right';
    const CLASS_NAME_PROFILE_CODE = 'profile_code';
    const CLASS_NAME_PROFILE_WIDTH = 'profile_width';
    const CLASS_NAME_PROFILE_HEIGHT = 'profile_height';
    const CLASS_NAME_PROFILE_COLOR = 'profile_color';
    const BAR_CUT_WASTE = 8;
    var inputs = 0;
    var globalLengths = [];

    function validate(event){
        var keycode = (event.which) ? event.which : event.keyCode;

        if (keycode > 31 && ((keycode < 48 || keycode > 57 ) && (keycode < 96 || keycode > 105))) {
            alert(" You can enter only characters 0 to 9 ");
            return false;
        }
        return true;
    }

    function calculateResult(){
        let lengthsArr = [];
        //recreate array with all the lengths
        const barLength = parseInt($(`.${BAR_LENGTH}`)[0].value);
        for(var i=1; i<=inputs; i++) {
            let length = parseInt($(`.${CLASS_NAME_LENGTH}${i}`)[0].value);
            let noLengths = parseInt($(`.${CLASS_NAME_NO}${i}`)[0].value);
            let profileTypeL = $(`.${CLASS_NAME_PROFILE_TYPE_LEFT}${i}`)[0].value;
            let profileTypeR = $(`.${CLASS_NAME_PROFILE_TYPE_RIGHT}${i}`)[0].value;
            let profileCode = $(`.${CLASS_NAME_PROFILE_CODE}${i}`)[0].value;
            let profileColor = $(`.${CLASS_NAME_PROFILE_COLOR}${i}`)[0].value;
            let profileWidth = $(`.${CLASS_NAME_PROFILE_WIDTH}${i}`)[0].value;
            let profileHeight = $(`.${CLASS_NAME_PROFILE_HEIGHT}${i}`)[0].value;

            if(!isNaN(noLengths) && !isNaN(length)){
                lengthsArr.push({length, noLengths, profileTypeL, profileTypeR, profileCode, profileColor, profileHeight, profileWidth});
            }
        }
        lengthsArr = lengthsArr.sort((item1, item2) => {
            return -(item1.length - item2.length)
        });
        globalLengths = lengthsArr;
        let noBars = 0;
        let results = [];
        while(lengthsArr.length !== 0) {
            noBars++;
            let barRest = barLength;
            let barResultingPieces = [];
            lengthsArr.forEach(({length, noLengths, profileTypeL, profileTypeR, profileCode, profileColor, profileHeight, profileWidth}, index) => {
                let cutsMade = 0;
                let potentialCuts = parseInt(barRest/(length+BAR_CUT_WASTE));
                potentialCuts = potentialCuts <= noLengths
                    ? potentialCuts
                    : noLengths;
                barRest-=potentialCuts*(length+BAR_CUT_WASTE);
                lengthsArr[index].noLengths -= potentialCuts;
                cutsMade = potentialCuts;
                if((potentialCuts < noLengths)   //poate mai putem adauga o bucata in plus eliminand ultima portiune de 8 mm
                    &&(barRest - length) >= 0 ) {
                      barRest -=length;
                      lengthsArr[index].noLengths--;
                      cutsMade++;
                }
                if(cutsMade > 0 ) {
                    barResultingPieces.push({
                        nrPieces: cutsMade,
                        lengthPieces: length,
                        profileTypeL,
                        profileTypeR,
                        profileCode,
                        profileColor,
                        profileWidth,
                        profileHeight
                    });
                }
            }, lengthsArr)
            results.push({barRest, barResultingPieces});
            lengthsArr = lengthsArr.filter((value, index, array) => {
                return (value.noLengths !== 0);
            });
        }
        buildDataTable(results, barLength);
        showResults(results, barLength);
        globalResults = results;
    }
    function buildDataTable(results, barLength) {
        console.log(results);
        const table = document.getElementById('datatable');
        let i = 1;
        let bars = [];
        bars = results.map(result => result.barResultingPieces).flat();
        bars.forEach(bar => {
            const row = table.insertRow(i);
            row.insertCell(0).innerText = '1';
            row.insertCell(1).innerText = (new Date()).getFullYear();
            row.insertCell(2).innerText = $('#project_name').val();
            row.insertCell(3).innerText = bar.profileCode;
            row.insertCell(4).innerText = bar.profileColor;
            row.insertCell(5).innerText = bar.profileColor;
            row.insertCell(6).innerText = `2vision_${bar.profileCode.replace(' ', '_')}.dxf`;
            row.insertCell(7).innerText = bar.profileHeight;
            row.insertCell(8).innerText = bar.profileWidth;
            row.insertCell(9).innerText = '0';
            row.insertCell(10).innerText = '123456789';
            row.insertCell(11).innerText = '';
            row.insertCell(12).innerText = barLength;
            row.insertCell(13).innerText = bar.nrPieces;
            row.insertCell(14).innerText = 'toc2670 900';
            row.insertCell(15).innerText = bar.lengthPieces;
            row.insertCell(16).innerText = bar.profileTypeL;
            row.insertCell(17).innerText = bar.profileTypeR;
            row.insertCell(18).innerText = '';
            row.insertCell(19).innerText = '';
            row.insertCell(20).innerText = '';
            row.insertCell(21).innerText = 'info?';
            row.insertCell(22).innerText = 'OMIFA';
            row.insertCell(23).innerText = '';
            row.insertCell(24).innerText = '';
            i++;
        })

    }

    function showResults(resultsArray, barLength) {
        let text = `Bari de ${barLength} necesare: <b>${resultsArray.length}</b> <br />`;
        $('#results').empty().append(text);
        text = ``;
        resultsArray.forEach((resultItem, index) => {
            text +=`<hr class="result">`
            text+= `Bara ${index+1}:<ul>`;
            resultItem.barResultingPieces.forEach(({nrPieces, lengthPieces, profileTypeL,profileTypeR, profileCode}) => {
                let type = nrPieces === 1 ? `bucata` : `bucati`;
                text+= `<li>${nrPieces} ${type} de ${lengthPieces} mm | ${profileTypeL} ---- ${profileTypeR} | ${profileCode} </li> `;
            });
            text+=`</ul>`;
            text+=`Ramas din bara: ${resultItem.barRest} <br />`;
        });

        $('#results').append(text);
    }

    function getGraphicsBar(leftD = 45, rightD = 45) {
        let barDiv = `<div class="d90 col-8">${leftD}`;
        if([45, 135].includes(leftD)) {
            barDiv+= ` <div class="d${leftD}l"></div>`;
        }
        if ([45,135].includes(rightD)) {
            barDiv+= `<div class="d${rightD}r"></div>`;
        }
        barDiv+= `<div style="right: -10px; position: absolute; top: -5px">${rightD}</div>`;

        return barDiv + `</div>`;
    }

    function appendResultsGraphics(leftD = 45, rightD = 45) {
            let barsGraphics = ``;
            const optionsString = globalLengths.map(({length}) => {
                return `<option>${length}</option>`
            }).join('');
            barsGraphics+=`<div class="row top-buffer" xmlns="http://www.w3.org/1999/html">
            ${this.getGraphicsBar(leftD, rightD)}
            <div class="col-4"><input class="graphics" type="number" value=1 min= "1" /> x
            <select id="resultSelection" type="number" >
                ${optionsString}
            </select>
            mm </div>
            </div>`;

        $('#graphics').append(barsGraphics);

    }

    function addInput() {
        inputs++;
        var classNameNo = `${CLASS_NAME_NO}${inputs}`;
        var classNameLength = `${CLASS_NAME_LENGTH}${inputs}`;
        var profileTypeOptions =
            `<option value="90">90</option>
             <option value="45">45</option>
             <option value="135">135</option>
            `;
        var pieceInput =
            `
             <table>
             <tr>
                <th>Cod profil</th>
                <th>Culoare</th>
                <th>Latime</th>
                <th>Inaltime</th>
             </tr>
             <tr>
                <td><input class="${CLASS_NAME_PROFILE_CODE}${inputs}" type="text" size="100" /></td>
                <td><input class="${CLASS_NAME_PROFILE_COLOR}${inputs}" type="text"  value="anodizat" id="color"/></td>
                <td><input class="${CLASS_NAME_PROFILE_WIDTH}${inputs}" type="text"  value="47.25" id="color"/></td>
                <td><input class="${CLASS_NAME_PROFILE_HEIGHT}${inputs}" type="text"  value="62.82" id="color"/></td>
             </tr>
            </table>
             <br />
             <input class="${classNameNo}" onClick="this.select();" type="text" value="1" onkeydown="return validate(event, this)" name="pieceNr"/>
                bucati de
                <select id="profileTypeLeft${inputs}" name="profileTypeLeft" class="${CLASS_NAME_PROFILE_TYPE_LEFT}${inputs}">${profileTypeOptions}</select>
                -----
             <select id="profileTypeRight${inputs}" name="profileTypeRight" class="${CLASS_NAME_PROFILE_TYPE_RIGHT}${inputs}">${profileTypeOptions}</select>
             |
             <input class="${classNameLength}" type="text" onkeydown="return validate(event, this)" name="pieceLength"/> mm
            <hr> `;
        $("#pieces").append(pieceInput);
    }

    function exportToExcel() {

        var elt = document.getElementById('datatable');
        var wb = XLSX.utils.table_to_book(elt, { sheet: "Sheet1" });
        return XLSX.writeFile(wb, 'clp_csv_cutting_list.xls');
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
<div class="row">
    <div class="col-6">
        <label for="length">Lungime bara</label>
        <input class="bar_length"   type="text" onkeydown="return validate(event,this)"  /> mm
        <u><a style="cursor: pointer; color: blue" onclick="exportToExcel()" onmouseover="" >Export to Excel</a></u>
        <br /> <br />
        <label for="project_name">Nume proiect</label> <br />
        <textarea name="Text1" cols="60" rows="5", id="project_name"></textarea>
        <br /> <br />
        <i>*Nota: </i> Lamele taie 8 mm din teava
    </div>
    <div class="col-3">
        <img src="https://raw.githubusercontent.com/andreea96/calculator/master/cap_stanga.png" alt="Capat stanga">
    </div>
    <div class="col-3">
        <img src="https://raw.githubusercontent.com/andreea96/calculator/master/cap_dreapta.png" alt="Capat dreapta">
    </div>
</div>
<br />
<hr>
<div id="pieces">

</div>
<button onclick="calculateResult()">Calculeaza rezultat</button> &nbsp; &nbsp;
<button onclick="addInput()">Adauga bucati dorite</button>  &nbsp; &nbsp;
<br />
<br />
<div class="row">
    <div class="col-6" id="results">

    </div>
</div>
<table id="datatable"  style="display:none">
<tr>
    <td> job_id </td>
    <td> job_year </td>
    <td> job_name </td>
    <td> mat_name </td>
    <td> mat_color_internal</td>
    <td> mat_color_external </td>
    <td> mat_image </td>
    <td> mat_profile_height </td>
    <td> mat_profile_width </td>
    <td> bar_id </td>
    <td> bar_idcode </td>
    <td> bar_count </td>
    <td> bar_length </td>
    <td> cut_pieces </td>
    <td> cut_idcode </td>
    <td> cut_length </td>
    <td> cut_leftangle </td>
    <td> cut_rightangle </td>
    <td> cut_compound_leftangle </td>
    <td> cut_compund_rightangle_saw </td>
    <td> cut_label_file </td>
    <td> cut_label_value1 </td>
    <td> cut_label_value2 </td>
    <td> cut_label_value3 </td>
    <td> cut_label_value4 </td>
</tr>

</table>
</body>
</html>